# -*- coding: utf-8 -*-
"""genel_hukuk.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1kD6SmAzFSEOYc66lIxnJomHb2Ed2HRyE
"""

# --- 1. AYARLAR VE KÃœTÃœPHANELER ---
!pip install groq datasets sentence-transformers -q

import os
import re
import torch
from google.colab import userdata
from groq import Groq
from datasets import load_dataset
from sentence_transformers import SentenceTransformer, util

# --- MODELLER BURADA TANIMLI (KOLAY ERÄ°ÅÄ°M) ---
EMBEDDING_MODEL_NAME = 'sentence-transformers/all-MiniLM-L6-v2' # Arama Modeli
LLM_MODEL_NAME = "llama-3.3-70b-versatile"                       # Cevap Modeli - GÃœNCELLENDÄ°

# API Key KontrolÃ¼
try:
    api_key = userdata.get('GROQ_API_KEY')
except:
    api_key = os.environ.get("GROQ_API_KEY")

if not api_key:
    print("âš ï¸ HATA: Groq API Key bulunamadÄ±! LÃ¼tfen sol menÃ¼deki 'Anahtar' (Secrets) kÄ±smÄ±na ekleyin.")
else:
    client = Groq(api_key=api_key)
    print("âœ… API BaÄŸlantÄ±sÄ± HazÄ±r")

# --- 2. RAG MOTORU (ARAMA SÄ°STEMÄ°) ---
class SemanticRAG:
    def __init__(self):
        self.vector_store = []
        self.contents = []
        print(f"ğŸ§  Arama Modeli YÃ¼kleniyor: {EMBEDDING_MODEL_NAME}...")
        try:
            self.model = SentenceTransformer(EMBEDDING_MODEL_NAME)
            print("âœ… Arama Modeli HazÄ±r!")
        except Exception as e:
            print(f"âŒ Model YÃ¼kleme HatasÄ±: {e}")

    def ingest(self, text_list):
        if not text_list: return
        print(f"ğŸ”„ {len(text_list)} veri iÅŸleniyor...")
        self.vector_store = self.model.encode(text_list, convert_to_tensor=True)
        self.contents = text_list
        print("âœ… Veriler hafÄ±zaya alÄ±ndÄ±.")

    def retrieve(self, query, top_k=3):
        query_vec = self.model.encode(query, convert_to_tensor=True)
        cosine_scores = util.cos_sim(query_vec, self.vector_store)[0]
        top_results = torch.topk(cosine_scores, k=min(top_k, len(self.contents)))

        results = []
        for score, idx in zip(top_results[0], top_results[1]):
            if score > 0.35:
                results.append(self.contents[idx])

        return "\n---\n".join(results) if results else "VeritabanÄ±nda bilgi yok."

# --- 3. DATASET YÃœKLEME ---
rag_engine = SemanticRAG()

print("ğŸ“¥ Dataset indiriliyor...")
try:
    ds = load_dataset("akerem1427/Hukukv4", split="train")
    # HÄ±zlÄ± test iÃ§in ilk 2000 veriyi alÄ±yoruz
    ds_subset = ds.select(range(min(len(ds), 2000)))

    text_data = []
    for row in ds_subset:
        combined = ""
        if 'instruction' in row and 'output' in row:
            combined = f"SORU: {row['instruction']}\nCEVAP: {row['output']}"
        elif 'text' in row:
            combined = row['text']

        if len(combined) > 20:
            text_data.append(combined)

    rag_engine.ingest(text_data)
except Exception as e:
    print(f"âŒ Dataset HatasÄ±: {e}")

# --- 4. ARAÃ‡LAR VE AJAN ---
def kanun_ara(query: str) -> str:
    return rag_engine.retrieve(query)

def calculator(expression: str) -> str:
    try: return str(eval(expression, {"__builtins__": None}, {}))
    except: return "Hata"

tools = [kanun_ara, calculator]
known_actions = {t.__name__: t for t in tools}

system_prompt = f"""
Sen TÃ¼rk Hukuk AsistanÄ±sÄ±n.
Kurallar:
1. 'kanun_ara' ile veritabanÄ±ndan bilgi bul.
2. Hesaplama iÃ§in 'calculator' kullan.
3. Sadece bulduÄŸun kanuna gÃ¶re cevap ver.
AraÃ§lar: kanun_ara, calculator
"""

class Agent:
    def __init__(self):
        self.messages = [{"role": "system", "content": system_prompt}]

    def execute(self, message):
        self.messages.append({"role": "user", "content": message})
        try:
            result = client.chat.completions.create(
                model=LLM_MODEL_NAME, # <--- Model burada kullanÄ±lÄ±yor
                messages=self.messages,
                temperature=0,
                stop=["PAUSE", "Observation:"]
            )
            response = result.choices[0].message.content
            self.messages.append({"role": "assistant", "content": response})
            return response
        except Exception as e:
            return f"API HatasÄ±: {e}"

# --- 5. Ã‡ALIÅTIRMA ---
action_re = re.compile(r'^Action: (\w+): (.*)$')

def query(question):
    agent = Agent()
    print(f"\nSORU: {question}")

    next_prompt = question # <--- DÃœZELTME: BaÅŸlangÄ±Ã§ deÄŸeri atandÄ±

    # Maksimum 5 tur dÃ¶ngÃ¼
    for _ in range(5):
        result = agent.execute(question) if _ == 0 else agent.execute(next_prompt)
        print(f"\033[94m{result}\033[0m")

        actions = [action_re.match(a) for a in result.split('\n') if action_re.match(a)]
        if actions:
            action, val = actions[0].groups()
            if action in known_actions:
                print(f"=> Ã‡alÄ±ÅŸÄ±yor: {action} ({val.strip()})")
                obs = known_actions[action](val.strip())
                print(f"GÃ¶zlem: {str(obs)[:300]}...")
                next_prompt = f"Observation: {obs}\nThought:"
            else:
                break
        elif "Answer:" in result:
            print(f"\nâœ… SONUÃ‡: {result.split('Answer:')[-1].strip()}")
            break

# TEST
if __name__ == "__main__":
    query("AnlaÅŸmalÄ± boÅŸanma davasÄ± aÃ§mak iÃ§in evlilik en az ne kadar sÃ¼rmÃ¼ÅŸ olmalÄ±dÄ±r?")

# --- GENEL HUKUK BENCHMARK TESTÄ° (HUKUKV4 DATASETÄ°NE UYGUN) ---

general_law_benchmark = [
    # --- KATEGORÄ° 1: Temel Hukuk Bilgisi (Anayasa & Medeni Hukuk) ---
    "OlaÄŸanÃ¼stÃ¼ hal (OHAL) ilan etme yetkisi kime aittir?",
    "Milletvekili seÃ§ilme yaÅŸÄ± en az kaÃ§tÄ±r?",
    "CumhurbaÅŸkanÄ±nÄ±n gÃ¶rev sÃ¼resi kaÃ§ yÄ±ldÄ±r ve bir kiÅŸi en fazla kaÃ§ kez seÃ§ilebilir?",
    "Anayasa Mahkemesi kaÃ§ Ã¼yeden oluÅŸur?",
    "Evlenme ehliyeti kazanmak iÃ§in olaÄŸan evlenme yaÅŸÄ± kaÃ§tÄ±r?",
    "AyÄ±rt etme gÃ¼cÃ¼ne sahip olmayan bir kiÅŸinin yaptÄ±ÄŸÄ± evlilik geÃ§erli midir?",
    "AnlaÅŸmalÄ± boÅŸanma davasÄ± aÃ§abilmek iÃ§in evlilik en az ne kadar sÃ¼rmÃ¼ÅŸ olmalÄ±dÄ±r?",
    "Vasiyetname dÃ¼zenleyebilmek iÃ§in kiÅŸinin kaÃ§ yaÅŸÄ±nÄ± doldurmuÅŸ olmasÄ± gerekir?",
    "MirasbÄ±rakanÄ±n altsoyu (Ã§ocuklarÄ±) varken eÅŸin yasal miras payÄ± oranÄ± nedir?",
    "BoÅŸanma davasÄ± aÃ§Ä±ldÄ±ktan sonra eÅŸlerin sadakat yÃ¼kÃ¼mlÃ¼lÃ¼ÄŸÃ¼ devam eder mi?",
    "EdinilmiÅŸ mallara katÄ±lma rejimine gÃ¶re, evlilik Ã¶ncesi alÄ±nan mallar paylaÅŸÄ±ma dahil edilir mi?",
    "BabalÄ±k davasÄ±, Ã§ocuÄŸun doÄŸumundan itibaren en geÃ§ ne kadar sÃ¼re iÃ§inde aÃ§Ä±lmalÄ±dÄ±r?",
    "Ä°sim deÄŸiÅŸtirme davasÄ± hangi mahkemede aÃ§Ä±lÄ±r?",

    # --- KATEGORÄ° 2: Ceza Hukuku & BorÃ§lar Hukuku (SuÃ§, Ceza ve SÃ¶zleÅŸmeler) ---
    "Kasten Ã¶ldÃ¼rme suÃ§unun temel ÅŸeklinin cezasÄ± nedir?",
    "MeÅŸru mÃ¼dafaa sÄ±nÄ±rÄ±nÄ±n heyecan, korku veya telaÅŸ nedeniyle aÅŸÄ±lmasÄ± durumunda ceza verilir mi?",
    "HÄ±rsÄ±zlÄ±k suÃ§unun gece vakti iÅŸlenmesi cezayÄ± nasÄ±l etkiler?",
    "Hakaret suÃ§unun ispat edilmesi durumunda ceza verilir mi?",
    "Taksirle bir kiÅŸinin Ã¶lÃ¼mÃ¼ne neden olmanÄ±n cezasÄ± nedir?",
    "SuÃ§a teÅŸebbÃ¼s halinde cezada ne kadar indirim yapÄ±lÄ±r?",
    "KiracÄ±, kira sÃ¶zleÅŸmesini feshetmek isterse ev sahibine en az kaÃ§ gÃ¼n Ã¶nceden bildirmelidir?",
    "Sebepsiz zenginleÅŸme davasÄ± aÃ§ma sÃ¼resi, maÄŸdurun hakkÄ±nÄ± Ã¶ÄŸrendiÄŸi tarihten itibaren kaÃ§ yÄ±ldÄ±r?",
    "Kefalet sÃ¶zleÅŸmesinin geÃ§erli olmasÄ± iÃ§in eÅŸin rÄ±zasÄ± gerekli midir?",
    "ZamanaÅŸÄ±mÄ±na uÄŸramÄ±ÅŸ bir borÃ§, borÃ§lu tarafÄ±ndan Ã¶denirse geri istenebilir mi?",
    "SatÄ±lan malÄ±n ayÄ±plÄ± Ã§Ä±kmasÄ± durumunda tÃ¼keticinin seÃ§imlik haklarÄ± nelerdir?",
    "BorÃ§lar Kanunu'na gÃ¶re genel zamanaÅŸÄ±mÄ± sÃ¼resi kaÃ§ yÄ±ldÄ±r?",

    # --- KATEGORÄ° 3: Matematiksel Hesaplamalar (Miras, Ceza Ä°ndirimi, Tazminat) ---
    "MirasbÄ±rakanÄ±n eÅŸi ve 3 Ã§ocuÄŸu varsa, mirasÄ±n ne kadarÄ± eÅŸe kalÄ±r (Kesirli ifade)?",
    "MirasbÄ±rakanÄ±n hiÃ§ Ã§ocuÄŸu yoksa, eÅŸi ve anne-babasÄ± hayatta ise eÅŸin miras payÄ± nedir?",
    "MÃ¼ebbet hapis cezasÄ± alan bir hÃ¼kÃ¼mlÃ¼, koÅŸullu salÄ±verilmeden yararlanmak iÃ§in en az kaÃ§ yÄ±l cezaevinde kalmalÄ±dÄ±r?",
    "AÄŸÄ±rlaÅŸtÄ±rÄ±lmÄ±ÅŸ mÃ¼ebbet hapis cezasÄ± alan bir hÃ¼kÃ¼mlÃ¼ kaÃ§ yÄ±l yattÄ±ktan sonra koÅŸullu salÄ±verilebilir?",
    "Bir iÅŸÃ§i 10.000 TL brÃ¼t Ã¼cret alÄ±yorsa ve kÄ±dem tazminatÄ± tavanÄ± 35.000 TL ise, 5 yÄ±llÄ±k kÄ±demi iÃ§in ne kadar tazminat alÄ±r?",
    "Gece vakti iÅŸlenen bir suÃ§ta ceza yarÄ± oranÄ±nda artÄ±rÄ±lÄ±yorsa, 4 yÄ±l hapis cezasÄ± alan biri toplam kaÃ§ yÄ±l ceza alÄ±r?",
    "Yasal faiz oranÄ± yÄ±llÄ±k %9 ise, 100.000 TL'lik bir borcun 1 yÄ±llÄ±k faizi kaÃ§ TL olur?",
    "HaftalÄ±k 45 saati aÅŸan 4 saatlik fazla Ã§alÄ±ÅŸma iÃ§in, saatlik Ã¼creti 200 TL olan iÅŸÃ§iye ne kadar Ã¶deme yapÄ±lÄ±r?",

    # --- KATEGORÄ° 4: MantÄ±ksal Muhakeme ve Senaryo Analizi ---
    "KiracÄ± kirayÄ± Ã¶demezse ev sahibi hemen tahliye davasÄ± aÃ§abilir mi, yoksa Ã¶nce ihtar mÄ± Ã§ekmelidir?",
    "Bir kiÅŸi sarhoÅŸken suÃ§ iÅŸlerse cezai ehliyeti tam mÄ±dÄ±r yoksa ceza indirimi alÄ±r mÄ±?",
    "SÃ¶zlÃ¼ olarak yapÄ±lan gayrimenkul satÄ±ÅŸ sÃ¶zleÅŸmesi geÃ§erli midir?",
    "Ä°ÅŸveren, iÅŸÃ§iyi sendikaya Ã¼ye olduÄŸu iÃ§in iÅŸten Ã§Ä±karÄ±rsa bu geÃ§erli bir fesih nedeni sayÄ±lÄ±r mÄ±?",
    "MirasÃ§Ä±lar mirasÄ± reddetmek isterse (reddi miras), Ã¶lÃ¼m tarihinden itibaren kaÃ§ ay iÃ§inde baÅŸvuru yapmalÄ±dÄ±r?",
    "Trafik kazasÄ±nda yaralanan kiÅŸi, maddi ve manevi tazminat davasÄ±nÄ± kime karÅŸÄ± aÃ§abilir?"
]

print(f"Toplam {len(general_law_benchmark)} adet GENEL HUKUK sorusu teste tabi tutuluyor...\n")

# AjanÄ± her bir soru iÃ§in Ã§alÄ±ÅŸtÄ±r
for i, soru in enumerate(general_law_benchmark):
    print("\n" + "#"*60)
    print(f"BENCHMARK SORU: {i+1} / {len(general_law_benchmark)}")
    print("#"*60)

    try:
        # AjanÄ± Ã§alÄ±ÅŸtÄ±r (Mevcut query fonksiyonunu kullanÄ±yoruz)
        query(soru)
    except Exception as e:
        print(f"HATA OLUÅTU: {e}")

    print("\n" + "-"*30 + " SIRADAKÄ° SORU " + "-"*30 + "\n")

print("TÃœM TESTLER BAÅARIYLA TAMAMLANDI.")
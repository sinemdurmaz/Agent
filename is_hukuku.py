# -*- coding: utf-8 -*-
"""is_hukuku.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1kD6SmAzFSEOYc66lIxnJomHb2Ed2HRyE
"""

!pip install groq

import re
import math
from collections import Counter
from google.colab import userdata
from groq import Groq

!pip install PyPDF2
import os
import re
import math
import PyPDF2  # PDF okumak iÃ§in
from collections import Counter

try:
    from groq import Groq
    from google.colab import userdata
    api_key = userdata.get('GROQ_API_KEY')
except:
    api_key = os.environ.get("GROQ_API_KEY")

client = Groq(api_key=api_key)

# --- 1. RAG MOTORU (SimpleRAG) ---
class SimpleRAG:
    def __init__(self):
        self.vector_store = []

    def get_embedding(self, text):
        words = re.findall(r'\w+', text.lower())
        return Counter(words)

    def _cosine_similarity(self, vec1, vec2):
        intersection = set(vec1.keys()) & set(vec2.keys())
        numerator = sum([vec1[x] * vec2[x] for x in intersection])
        sum1 = sum([vec1[x]**2 for x in vec1.keys()])
        sum2 = sum([vec2[x]**2 for x in vec2.keys()])
        denominator = math.sqrt(sum1) * math.sqrt(sum2)
        return float(numerator) / denominator if denominator else 0.0

    def ingest(self, text):
        # Metni "MADDE" kelimesine gÃ¶re bÃ¶lerek kanun maddelerini ayÄ±rÄ±yoruz
        # Bu sayede her madde ayrÄ± bir bilgi parÃ§acÄ±ÄŸÄ± (chunk) oluyor.
        chunks = text.split('MADDE')

        for chunk in chunks:
            if len(chunk.strip()) > 20: # Ã‡ok kÄ±sa parÃ§alarÄ± atla
                # BaÅŸÄ±na tekrar MADDE ekle ki anlam bozulmasÄ±n
                clean_chunk = "MADDE " + chunk.strip()
                self.vector_store.append({"content": clean_chunk, "vector": self.get_embedding(clean_chunk)})

    def retrieve(self, query, top_k=3):
        query_vec = self.get_embedding(query)
        scores = sorted([(self._cosine_similarity(query_vec, item["vector"]), item["content"]) for item in self.vector_store], key=lambda x: x[0], reverse=True)
        return "\n---\n".join([item[1] for item in scores[:top_k] if item[0] > 0.05])

# --- 2. PDF OKUMA VE YÃœKLEME ---
def load_pdf_data(pdf_path):
    full_text = ""
    try:
        with open(pdf_path, 'rb') as f:
            reader = PyPDF2.PdfReader(f)
            print(f"ğŸ“„ PDF YÃ¼kleniyor... Toplam Sayfa: {len(reader.pages)}")
            for page in reader.pages:
                text = page.extract_text()
                if text:
                    full_text += text + "\n"
        return full_text
    except FileNotFoundError:
        return None

# Veri Setini YÃ¼kle (PDF'ten)
rag_engine = SimpleRAG()
pdf_content = load_pdf_data('document.pdf') # Senin yÃ¼klediÄŸin dosya adÄ±

if pdf_content:
    rag_engine.ingest(pdf_content)
    print("âœ… Ä°ÅŸ Kanunu PDF'i baÅŸarÄ±yla iÅŸlendi ve hafÄ±zaya alÄ±ndÄ±!")
else:
    print("âš ï¸ HATA: 'document.pdf' dosyasÄ± bulunamadÄ±. LÃ¼tfen dosyayÄ± yÃ¼kleyin.")

# --- 3. ARAÃ‡LAR (TOOLS) ---
def calculator(expression: str) -> str:
    """Matematiksel iÅŸlemleri yapar. Ã–rn: 300 * 22 veya (600000/12)*1.5"""
    try:
        allowed = set("0123456789+-*/(). ")
        if not all(c in allowed for c in expression):
            return "Hata: GeÃ§ersiz karakter."
        return str(eval(expression, {"__builtins__": None}, {}))
    except Exception as e:
        return f"Hesaplama HatasÄ±: {e}"

def kanun_ara(query: str) -> str:
    """Ä°ÅŸ kanunu maddeleri, izinler, tazminat ve haklar hakkÄ±nda bilgi arar."""
    res = rag_engine.retrieve(query)
    return res if res else "Kanun maddelerinde bu konuda bilgi bulunamadÄ±."

tools = [calculator, kanun_ara]
tools_desc = "\n".join([f"{t.__name__}: {t.__doc__}" for t in tools])
known_actions = {t.__name__: t for t in tools}

# --- 4. AJAN (AGENT) ---
system_prompt = f"""
Sen uzman bir TÃ¼rk Ä°ÅŸ Hukuku DanÄ±ÅŸmanÄ±sÄ±n.
KullanÄ±cÄ±larÄ±n sorularÄ±nÄ±, yÃ¼klenen "4857 SayÄ±lÄ± Ä°ÅŸ Kanunu" PDF iÃ§eriÄŸine dayanarak cevaplarsÄ±n.

KURALLAR:
1. Her cevabÄ±nÄ± mutlaka 'kanun_ara' aracÄ±yla bulduÄŸun KANUN MADDESÄ°NE dayandÄ±r.
2. Hukuki hesaplamalar (KÄ±dem, Ä°hbar, Fazla Mesai) iÃ§in 'calculator' kullan.
3. Asla kiÅŸisel yorum yapma, sadece kanunda yazanÄ± sÃ¶yle.
4. Gerekli bilgiye ulaÅŸtÄ±ÄŸÄ±nda veya cevap verebildiÄŸinde 'Action: None' YAZMA. Bunun yerine direkt 'Answer:' etiketini kullan.

AraÃ§lar:
{tools_desc}

Cevap FormatÄ± (SÄ±rayla):
Thought: (DÃ¼ÅŸÃ¼nce sÃ¼reci)
Action: tool_name: input (EÄŸer bilgiye ihtiyaÃ§ varsa)
Observation: (AracÄ±n Ã§Ä±ktÄ±sÄ±)
... (Gerekirse tekrar Thought/Action/Observation) ...
Answer: (SonuÃ§ cevabÄ± - Sadece en sonda kullan)
"""

# --- 4. AGENT SINIFI (GÃœNCELLENDÄ°: DAHA HAFÄ°F MODEL) ---
class Agent:
    def __init__(self, system=""):
        self.system = system
        self.messages = []
        if self.system:
            self.messages.append({"role": "system", "content": system})

    def __call__(self, message):
        self.messages.append({"role": "user", "content": message})
        result = self.execute()
        self.messages.append({"role": "assistant", "content": result})
        return result

    def execute(self):
        # API Ã§aÄŸrÄ±sÄ± - MODELÄ° DEÄÄ°ÅTÄ°RDÄ°K
        # "llama-3.3-70b-versatile" YERÄ°NE "llama-3.1-8b-instant" KULLANIYORUZ
        try:
            result = client.chat.completions.create(
                model="llama-3.1-8b-instant", # <-- DEÄÄ°ÅÄ°KLÄ°K BURADA
                messages=self.messages,
                temperature=0,
                stop=["PAUSE", "Observation:", "<|"]
            )
            return result.choices[0].message.content
        except Exception as e:
            return f"API HATASI: {e}"


# --- 5. ORKESTRASYON DÃ–NGÃœSÃœ (DÃœZELTÄ°LMÄ°Å) ---
import re
action_re = re.compile(r'^Action: (\w+): (.*)$')

def query(question, max_turns=10):
    i = 0
    # Agent sÄ±nÄ±fÄ± artÄ±k yukarÄ±da tanÄ±mlÄ± olduÄŸu iÃ§in hata vermeyecek
    react_agent = Agent(system_prompt)
    next_prompt = question

    print(f"\n{'='*40}\nQUESTION: {question}\n{'='*40}")

    while i < max_turns:
        i += 1
        result = react_agent(next_prompt)
        print(f"\033[94m{result}\033[0m") # Mavi renkli Ã§Ä±ktÄ±

        # Action satÄ±rlarÄ±nÄ± bul
        # Regex ile satÄ±r satÄ±r kontrol ediyoruz
        actions = [action_re.match(a) for a in result.split('\n') if action_re.match(a)]

        if actions:
            action, action_input = actions[0].groups()

            # Action adÄ±nÄ± ve inputu temizle (fazla boÅŸluklarÄ± at)
            action = action.strip()
            action_input = action_input.strip()

            if action not in known_actions:
                print(f"Hata: Bilinmeyen aksiyon -> {action}")
                return

            print(f"=> Running {action} with input: {action_input}")

            try:
                # Fonksiyonu Ã§alÄ±ÅŸtÄ±r
                observation = known_actions[action](action_input)
            except Exception as e:
                observation = f"Error executing tool: {e}"

            # --- DÃœZELTME 1: Ã‡Ä±ktÄ± Ã§ok uzunsa kÄ±rpÄ±yoruz ---
            observation_str = str(observation)
            if len(observation_str) > 2000:
                observation_str = observation_str[:2000] + "... (kÄ±saltÄ±ldÄ±)"

            print(f"Observation: {observation_str}")

            # --- DÃœZELTME 2: Modele 'DÃ¼ÅŸÃ¼nmeye Devam Et' komutu ---
            next_prompt = f"Observation: {observation_str}\nThought:"

        else:
            # Action yoksa cevap gelmiÅŸ demektir
            if "Answer:" in result:
                 print("\n\033[92m--- FINAL ANSWER FOUND ---\033[0m")
                 print(result.split("Answer:")[-1].strip())
            return

# Kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in (Ã–nceki hÃ¼crelerde client, system_prompt ve tools tanÄ±mlÄ± olmalÄ±)
if __name__ == "__main__":
    query("HaftalÄ±k Ã§alÄ±ÅŸma saati en fazla kaÃ§ olabilir?")

# --- 6. OTOMATÄ°K BENCHMARK TESTÄ° ---

# Ã–nce sorularÄ± listeye alÄ±yoruz
benchmark_questions = [
    # --- KATEGORÄ° 1: Temel Bilgi ---
    "Deneme sÃ¼resi en fazla kaÃ§ ay olabilir?",
    "HaftalÄ±k Ã§alÄ±ÅŸma sÃ¼resi yasal olarak en Ã§ok kaÃ§ saattir?",
    "YÄ±llÄ±k Ã¼cretli izin hakkÄ± kazanmak iÃ§in en az ne kadar Ã§alÄ±ÅŸmak gerekir?",
    "Gece Ã§alÄ±ÅŸma sÃ¼resi en fazla kaÃ§ saat olabilir?",
    "Ara dinlenmesi 4 saatten kÄ±sa sÃ¼reli iÅŸlerde kaÃ§ dakikadÄ±r?",
    "7.5 saatten fazla sÃ¼ren iÅŸlerde ara dinlenmesi ne kadardÄ±r?",
    "Erkek iÅŸÃ§iye eÅŸinin doÄŸum yapmasÄ± halinde kaÃ§ gÃ¼n izin verilir?",
    "Ä°ÅŸÃ§inin evlenmesi durumunda kaÃ§ gÃ¼n mazeret izni verilir?",
    "Birinci derece yakÄ±nÄ±nÄ± kaybeden iÅŸÃ§iye kaÃ§ gÃ¼n Ã¶lÃ¼m izni verilir?",
    "SÃ¼t izni, Ã§ocuk kaÃ§ yaÅŸÄ±na gelene kadar kullandÄ±rÄ±lÄ±r?",
    "GÃ¼nde 1.5 saat olan sÃ¼t izni hangi yaÅŸ grubundaki Ã§ocuklar iÃ§indir?",
    "Ä°ÅŸ sÃ¶zleÅŸmesi feshinde bildirim sÃ¼resi 6 aydan az Ã§alÄ±ÅŸan iÅŸÃ§i iÃ§in kaÃ§ haftadÄ±r?",
    "6 ay ile 1.5 yÄ±l arasÄ± kÄ±demi olan iÅŸÃ§i iÃ§in ihbar sÃ¼resi kaÃ§ haftadÄ±r?",
    "1.5 yÄ±l ile 3 yÄ±l arasÄ± kÄ±demi olan iÅŸÃ§i iÃ§in ihbar sÃ¼resi kaÃ§ haftadÄ±r?",
    "3 yÄ±ldan fazla kÄ±demi olan iÅŸÃ§i iÃ§in ihbar sÃ¼resi kaÃ§ haftadÄ±r?",
    "Yeni iÅŸ arama izni gÃ¼nde en az kaÃ§ saattir?",
    "KadÄ±n iÅŸÃ§iler doÄŸumdan Ã¶nce kaÃ§ hafta Ã§alÄ±ÅŸtÄ±rÄ±lmaz?",
    "KadÄ±n iÅŸÃ§iler doÄŸumdan sonra kaÃ§ hafta Ã§alÄ±ÅŸtÄ±rÄ±lmaz?",
    "Zorunlu nedenlerle fazla Ã§alÄ±ÅŸma durumunda iÅŸÃ§inin onayÄ± gerekir mi?",
    "Telafi Ã§alÄ±ÅŸmasÄ± gÃ¼nde en fazla kaÃ§ saat olabilir?",
    "Telafi Ã§alÄ±ÅŸmasÄ± tatil gÃ¼nlerinde yapÄ±labilir mi?",
    "Ãœcret kesme cezasÄ± bir ayda en fazla ne kadar olabilir?",
    "KÄ±smi sÃ¼reli Ã§alÄ±ÅŸan iÅŸÃ§inin sigorta prim gÃ¼n sayÄ±sÄ± nasÄ±l hesaplanÄ±r?",
    "Ã‡aÄŸrÄ± Ã¼zerine Ã§alÄ±ÅŸmada haftalÄ±k Ã§alÄ±ÅŸma sÃ¼resi belirlenmemiÅŸse kaÃ§ saat kabul edilir?",
    "YeraltÄ± ve maden iÅŸlerinde Ã§alÄ±ÅŸanlarÄ±n yÄ±llÄ±k izin sÃ¼releri kaÃ§ gÃ¼n artÄ±rÄ±lÄ±r?",

    # --- KATEGORÄ° 2: Hesaplama ve MantÄ±k ---
    "HaftalÄ±k 45 saati aÅŸan her bir saat fazla Ã§alÄ±ÅŸma iÃ§in Ã¼cret yÃ¼zde kaÃ§ zamlÄ± Ã¶denir?",
    "Ä°ÅŸÃ§i fazla Ã§alÄ±ÅŸma Ã¼creti yerine serbest zaman kullanmak isterse, 1 saatlik fazla Ã§alÄ±ÅŸma iÃ§in kaÃ§ dakika serbest zaman hak eder?",
    "Fazla sÃ¼relerle Ã§alÄ±ÅŸmalarda (45 saatin altÄ±nda anlaÅŸÄ±lan durumlarda) her bir saat iÃ§in Ã¼cret yÃ¼zde kaÃ§ artÄ±rÄ±lÄ±r?",
    "5 yÄ±llÄ±k kÄ±demi olan bir iÅŸÃ§inin yÄ±llÄ±k izin sÃ¼resi kaÃ§ gÃ¼ndÃ¼r?",
    "16 yaÅŸÄ±ndaki bir iÅŸÃ§inin yÄ±llÄ±k Ã¼cretli izin sÃ¼resi en az kaÃ§ gÃ¼n olabilir?",
    "55 yaÅŸÄ±ndaki bir iÅŸÃ§inin yÄ±llÄ±k Ã¼cretli izin sÃ¼resi en az kaÃ§ gÃ¼n olabilir?",
    "KÄ±dem tazminatÄ± hesaplanÄ±rken bir iÅŸÃ§inin 5 yÄ±l 6 ay Ã§alÄ±ÅŸmasÄ± varsa, 6 aylÄ±k kÄ±sÄ±m hesaba katÄ±lÄ±r mÄ±?",
    "Bir iÅŸÃ§i gÃ¼nde 11 saatten fazla Ã§alÄ±ÅŸtÄ±rÄ±labilir mi?",
    "Ä°ÅŸÃ§inin brÃ¼t Ã¼creti 20.000 TL ise ve 10 saat fazla mesai yaptÄ±ysa, fazla mesai Ã¼creti toplamÄ± ne kadar olur?",
    "Ä°ÅŸÃ§i haklÄ± nedenle derhal fesih yaparsa ihbar tazminatÄ± Ã¶der mi?",
    "Ä°ÅŸveren haklÄ± nedenle (Madde 25/II) fesih yaparsa kÄ±dem tazminatÄ± Ã¶der mi?",
    "Ä°hbar sÃ¼resine uyulmadan iÅŸten Ã§Ä±karÄ±lan 4 yÄ±llÄ±k bir iÅŸÃ§iye ne kadarlÄ±k Ã¼cret tutarÄ±nda ihbar tazminatÄ± Ã¶denmelidir?",
    "Bir yÄ±lda yapÄ±labilecek toplam fazla Ã§alÄ±ÅŸma sÃ¼resi en Ã§ok kaÃ§ saattir?",
    "HaftalÄ±k iÅŸ gÃ¼nlerinin 6 gÃ¼n olduÄŸu bir iÅŸyerinde, gÃ¼nde 7.5 saat Ã§alÄ±ÅŸan iÅŸÃ§i haftada kaÃ§ saat Ã§alÄ±ÅŸmÄ±ÅŸ olur?",
    "Engelli personel Ã§alÄ±ÅŸtÄ±rma zorunluluÄŸu oranÄ± yÃ¼zde kaÃ§tÄ±r?",

    # --- KATEGORÄ° 3: Zor Sorular ---
    "Belirli sÃ¼reli iÅŸ sÃ¶zleÅŸmesi kendiliÄŸinden sona erdiÄŸinde kÄ±dem tazminatÄ± Ã¶denir mi?",
    "Hamilelik nedeniyle iÅŸten ayrÄ±lan iÅŸÃ§i kÄ±dem tazminatÄ± alabilir mi?",
    "Askerlik nedeniyle iÅŸten ayrÄ±lan iÅŸÃ§i kÄ±dem tazminatÄ± alabilir mi?",
    "Ä°ÅŸÃ§i kendi isteÄŸiyle (istifa) ayrÄ±lÄ±rsa kÄ±dem tazminatÄ± alabilir mi?",
    "Hafta tatilinde Ã§alÄ±ÅŸan iÅŸÃ§iye Ã¼creti nasÄ±l Ã¶denir?"
]

print(f"Toplam {len(benchmark_questions)} adet soru teste tabi tutuluyor...\n")

# DÃ¶ngÃ¼yÃ¼ baÅŸlatÄ±yoruz ve her soruyu ajana soruyoruz
for i, soru in enumerate(benchmark_questions):
    print("\n" + "#"*60)
    print(f"TEST NO: {i+1} / {len(benchmark_questions)}")
    print("#"*60)

    try:
        # Senin query fonksiyonunu Ã§aÄŸÄ±rÄ±yoruz
        query(soru)
    except Exception as e:
        print(f"HATA: Bu soruda bir sorun oluÅŸtu: {e}")

    print("\n" + "-"*30 + " SONRAKÄ° SORUYA GEÃ‡Ä°LÄ°YOR " + "-"*30 + "\n")

print("TÃœM TESTLER TAMAMLANDI.")